<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bài kiểm tra Toán</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-50">

  <section id="quiz-section">
    <form id="quiz-form" class="space-y-4">
      <div id="quiz-container" class="space-y-4"></div>
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Nộp bài</button>
    </form>
  </section>

  <section id="result-section" class="hidden">
    <h2 class="text-xl font-bold">Kết quả</h2>
    <p>Học sinh: <span id="student-name-result"></span></p>
    <p>Điểm: <span id="final-score"></span></p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // === Cấu hình Firebase ===
    const firebaseConfig = {
  apiKey: "AIzaSyBlIoi1hfbVklz3AeacqrGQ0sT0H9hbdXU",

  authDomain: "toan11-thay-ha.firebaseapp.com",

  projectId: "toan11-thay-ha",

  storageBucket: "toan11-thay-ha.firebasestorage.app",

  messagingSenderId: "413456859402",

  appId: "1:413456859402:web:a15fd6699196dbf909faf3",

  measurementId: "G-94JHCQNEHY"

    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === Config Quiz ===
    const QUIZ_ID = "toan11-001";
    const QUIZ_NAME = "Bài kiểm tra Toán 11 - Lượng giác";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx0D3ztawclSEexcWorJpe8B1cCz2YlAjKSc-EhqkcgE98PJPLo_3TTl0tl5IT0VBvP/exec";

    // === Demo dữ liệu đề thi ===
    const quizData = [
      { type: "mcq", q: "Câu 1: sin(90°) = ?", c: ["0", "1", "-1"], a: "1" },
      { type: "true-false", q: "Câu 2: Đ/S", s: [
        { st: "cos(0°) = 1", a: true },
        { st: "tan(45°) = 2", a: false }
      ]},
      { type: "short-answer", q: "Câu 3: cos(180°) = ?", a: "-1" }
    ];

    // === Thông tin HS (demo) ===
    const currentUser = {
      studentId: "HS01",
      fullname: "Nguyễn Văn A",
      className: "11A1",
      school: "THPT Bắc Giang"
    };

    // === Biến trạng thái ===
    let userAnswers = [];
    let quizStartTime = Date.now();
    const quizForm = document.getElementById("quiz-form");
    const quizSection = document.getElementById("quiz-section");
    const resultSection = document.getElementById("result-section");
    const quizContainer = document.getElementById("quiz-container");
    const studentNameResult = document.getElementById("student-name-result");
    const finalScore = document.getElementById("final-score");

    // === Render đề ===
    quizData.forEach((q, i) => {
      const div = document.createElement("div");
      div.classList.add("p-4", "bg-white", "rounded", "shadow");

      if (q.type === "mcq") {
        div.innerHTML = `<p>${q.q}</p>` + q.c.map((opt, idx) =>
          `<label><input type="radio" name="q${i}" value="${opt}"> ${opt}</label><br>`).join("");
      }

      if (q.type === "true-false") {
        div.innerHTML = `<p>${q.q}</p>` + q.s.map((st, idx) =>
          `<label>${st.st}
             <input type="radio" name="q${i}-${idx}" value="true"> Đúng
             <input type="radio" name="q${i}-${idx}" value="false"> Sai
           </label><br>`).join("");
      }

      if (q.type === "short-answer") {
        div.innerHTML = `<p>${q.q}</p><input type="text" name="q${i}" class="border rounded p-1">`;
      }

      quizContainer.appendChild(div);
    });

    // === Lấy câu trả lời ===
    function collectAnswers() {
      userAnswers = quizData.map((q, i) => {
        if (q.type === "mcq") {
          const selected = document.querySelector(`input[name="q${i}"]:checked`);
          return selected ? selected.value : null;
        }
        if (q.type === "true-false") {
          return q.s.map((st, idx) => {
            const sel = document.querySelector(`input[name="q${i}-${idx}"]:checked`);
            return sel ? sel.value === "true" : null;
          });
        }
        if (q.type === "short-answer") {
          const inp = document.querySelector(`input[name="q${i}"]`);
          return inp ? inp.value.trim() : null;
        }
      });
    }

    // === Chuẩn hoá đáp án để gửi GAS ===
    function stringifyAnswer(q, ans) {
      if (q.type === "mcq") return ans || "";
      if (q.type === "short-answer") return ans || "";
      if (q.type === "true-false") return ans.map(v => v === true ? "D" : v === false ? "S" : "").join(",");
      return "";
    }
    function buildAnswersArray(quizDataRef, userAnswersRef) {
      return quizDataRef.map((q, i) => stringifyAnswer(q, userAnswersRef[i]));
    }

    // === Submit ===
    quizForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      collectAnswers();
      const timeTaken = Math.round((Date.now() - quizStartTime) / 1000);
      let totalScore = 0;

      quizData.forEach((q, i) => {
        const ans = userAnswers[i];
        if (q.type === "mcq" && ans === q.a) totalScore += 0.25;
        if (q.type === "short-answer" && ans && ans.toLowerCase() === q.a.toLowerCase()) totalScore += 1;
        if (q.type === "true-false") {
          let correctCount = 0;
          q.s.forEach((st, idx) => { if (ans[idx] === st.a) correctCount++; });
          const pointsMap = [0, 0.1, 0.25, 0.5, 1];
          totalScore += pointsMap[correctCount];
        }
      });

      // Hiển thị kết quả
      studentNameResult.textContent = currentUser.fullname;
      finalScore.textContent = totalScore.toFixed(2);
      quizSection.classList.add("hidden");
      resultSection.classList.remove("hidden");

      // 1) Lưu Firestore
      await addDoc(collection(db, "quizResults"), {
        ...currentUser,
        quizId: QUIZ_ID,
        quizName: QUIZ_NAME,
        answers: userAnswers,
        score: totalScore,
        timeTaken: timeTaken,
        timestamp: serverTimestamp()
      });

      // 2) Gửi Apps Script
      await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "submit_result",
          ...currentUser,
          quizId: QUIZ_ID,
          quizName: QUIZ_NAME,
          answers: buildAnswersArray(quizData, userAnswers),
          score: totalScore,
          timeTaken: timeTaken
        })
      });
    });
  </script>
</body>
</html>
